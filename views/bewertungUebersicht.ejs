<% pageTitle="Abgaben verwalten" %>

<div class="d-flex align-items-center justify-content-between mb-4">
    <h2 class="h4 m-0">Abgaben und Challenge-Status</h2>
    <span class="badge bg-info text-dark">
        Challenges: <%= abgaben.length %>
    </span>
</div>

<div class="row mb-4 g-2" id="filterContainer">
    
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text">Status:</span>
            <select class="form-select" id="statusFilter">
                <% statusOptions.forEach(opt => { %>
                    <option value="<%= opt %>" <%= activeStatus === opt ? 'selected' : '' %>>
                        <% 
                            let display = opt.charAt(0).toUpperCase() + opt.slice(1);
                            if (opt === 'offen') display = 'Noch nicht abgegeben';
                            if (opt === 'eingereicht') display = 'Zur Bewertung';
                            if (opt === 'alle') display = 'Alle Status';
                        %>
                        <%= display %>
                    </option>
                <% }) %>
            </select>
        </div>
    </div>

    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" id="bewertungSearch" class="form-control"
                placeholder="Suche nach Challenge oder Team..." value="<%= searchTerm || '' %>" autocomplete="off">
        </div>
    </div>
</div>
<div class="table-responsive">
    <table class="table table-hover table align-middle m-0 table-light">
        <thead class="table-light">
            <tr>
                <th scope="col"># Challenge ID</th>
                <th scope="col">Challenge</th>
                <th scope="col">Team</th>
                <th scope="col">Status</th>
                <th scope="col">Eingereicht am</th>
                <th scope="col" class="text-end" style="min-width: 150px;">Aktionen</th>
            </tr>
        </thead>
        <tbody>
            <% if (abgaben.length === 0) { %>
                <tr>
                    <td colspan="6" class="text-center py-4 text-muted">
                        Keine Challenges gefunden (Filter leert).
                    </td>
                </tr>
            <% } %>

            <% abgaben.forEach(abgabe => { %>
                <tr>
                    <td class="text-muted small"><%= abgabe.challenge_id %></td>
                    <td class="fw-medium">
                        <%= abgabe.challenge_title %>
                    </td>
                    <td>
                        <%= abgabe.team_name %>
                    </td>
                    <td>
                        <% 
                            let statusClass = 'secondary';
                            let statusText = abgabe.status.charAt(0).toUpperCase() + abgabe.status.slice(1);

                            if (abgabe.status === 'eingereicht') { 
                                statusClass = 'danger'; // üõë Rot f√ºr "Zur Bewertung"
                                statusText = 'Zur Bewertung';
                            }
                            if (abgabe.status === 'bewertet') statusClass = 'success';
                            if (abgabe.status === 'abgelehnt') statusClass = 'dark';
                            if (abgabe.status === 'entwurf') statusClass = 'warning text-dark';
                            if (abgabe.status === 'offen') { // üõë NEU: Wenn noch keine Abgabe erstellt
                                statusClass = 'info text-dark';
                                statusText = 'Nicht abgegeben';
                            }
                        %>
                        <span class="badge bg-<%= statusClass %>">
                            <%= statusText %>
                        </span>
                    </td>
                    <td>
                        <% if (abgabe.created_at) { %>
                            <%= new Date(abgabe.created_at).toLocaleDateString('de-DE') %>
                        <% } else { %>
                            -
                        <% } %>
                    </td>
                    <td class="text-end">
                        <% if (abgabe.id) { %>
                            <a href="/bewertung/<%= abgabe.id %>" class="btn btn-sm btn-custom-edit">
                                <% if (abgabe.status === 'bewertet') { %>
                                    Bewertung ansehen
                                <% } else { %>
                                    Bewerten
                                <% } %>
                            </a>
                        <% } else { %>
                            <span class="text-muted small">Wartet auf Abgabe</span>
                        <% } %>
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const statusFilter = document.getElementById('statusFilter');
        const searchInput = document.getElementById('bewertungSearch');

        let searchTimeout;

        function applyFilters() {
            const currentStatus = statusFilter.value;
            const currentSearch = searchInput.value.trim();

            const params = new URLSearchParams();
            
            // Status-Filter nur setzen, wenn nicht 'alle'
            if (currentStatus && currentStatus !== 'alle') {
                params.set('status', currentStatus);
            }
            // Such-Filter nur setzen, wenn ein Begriff > 0 Zeichen vorhanden ist
            if (currentSearch) {
                params.set('search', currentSearch);
            }
            
            // Zur neuen URL weiterleiten
            window.location.href = `/bewertung?${params.toString()}`;
        }

        // Event Listener f√ºr Status-Filter (bei Auswahl sofort filtern)
        statusFilter.addEventListener('change', function () {
            applyFilters();
        });

        // Event Listener f√ºr Sucheingabe (mit Debounce)
        searchInput.addEventListener('input', function () {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                applyFilters();
            }, 500); // 500ms Verz√∂gerung 
        });
    });
</script>