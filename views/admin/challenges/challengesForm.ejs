<% pageTitle=title %>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

  <h1 class="h4 mb-3">
    <%= title %>
  </h1>
  <form action="<%= action %>" method="POST" id="challengeForm">


    <% if (item.id) { %>

<input type="hidden" name="_method" value="PUT">

<% } %>


        <div class="row g-3">
          <div class="col-md-6">
            <div class="input-group mb-3">
              <span class="input-group-text">Aufgabenpaket *</span>
              <select name="aufgabenpaket_id" class="form-control" required>
                <option value="">Bitte wählen...</option>
                <% aufgabenpakete.forEach(paket=> { %>
                  <option value="<%= paket.id %>" <%=(Number(item.aufgabenpaket_id)===Number(paket.id)) ? 'selected'
                    : '' %>
                    >
                    <%= paket.title %> (<%= paket.kategorie %>)
                  </option>
                  <% }) %>
              </select>
            </div>
          </div>

          <div class="col-md-3">
            <div class="input-group mb-3">
              <span class="input-group-text">Schuljahr</span>
              <select name="schuljahr_id" class="form-control" required>
                <option value="">Schuljahr wählen</option>
                <% schuljahre.forEach(jahr=> { %>
                  <option value="<%= jahr.id %>" <%=(item.schuljahr_id==jahr.id) ? 'selected' : '' %>>
                    <%= jahr.name %>
                  </option>
                  <% }) %>
              </select>
            </div>
          </div>


          <div class="col-md-3">
            <div class="input-group mb-3">
              <span class="input-group-text" style="cursor: pointer;"
                onclick="document.getElementById('dateInput').showPicker()">
                <i class="bi bi-calendar"></i>
              </span>
              <input type="date" class="form-control custom-date-input" name="abgabedatum" id="dateInput"
                value="<%= item.abgabedatum ? new Date(item.abgabedatum).toISOString().split('T')[0] : '' %>">
            </div>
          </div>

          <div class="input-group mb-3 align-top-stretch">
            <span class="input-group-text">Challenge-Zusatzinformationen</span>
            <textarea name="zusatzinfos" class="form-control" rows="3"
              placeholder="Spezielle Anweisungen oder Hinweise für diese Challenge"><%= item.zusatzinfos || '' %></textarea>
          </div>
        </div>

        <h5 class="mb-3">Teams</h5>

        <input type="hidden" id="existingTeamsData" value='<%= JSON.stringify(existingTeam || []) %>'>

        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <label class="form-label mb-0">Aktuelle Teams</label>
            <button type="button" class="btn btn-custom-safe" data-bs-toggle="modal" data-bs-target="#teamModal"
              id="openCreateTeamModal">
              <i class="bi bi-plus-circle"></i> Neues Team erstellen
            </button>
          </div>
          <div id="teamsContainer">
          </div>
          <div id="noTeamsMessage" class="border rounded bg-light p-3 text-muted align-items-center w-100">
            <i class="bi bi-people me-2"></i>
            Noch keine Teams verfügbar
          </div>
        </div>

        <div class="modal fade" id="teamModal" tabindex="-1" aria-labelledby="teamModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="teamModalLabel">Neues Team erstellen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="mb-2">
                  <label class="form-label">Team Name *</label>
                  <input type="text" class="form-control" id="newTeamName" placeholder="Team Name eingeben...">
                </div>


                <div class="row g-2 mb-2">
                  <div class="col-md-6">
                    <input type="text" class="form-control form-control-sm" id="nameFilter"
                      placeholder="Namen suchen...">
                  </div>
                  <div class="col-md-3">
                    <select class="form-select form-select-sm" id="classFilter">
                      <option value="">Alle Klassen</option>
                      <% const klassen=[...new Set(schueler.map(s=> s.klasse_name).filter(Boolean).sort())]; %>
                        <% klassen.forEach(klasse=> { %>
                          <option value="<%= klasse %>">
                            <%= klasse %>
                          </option>
                          <% }) %>
                    </select>
                  </div>

                  <div class="col-md-3">
                    <select class="form-select form-select-sm" id="teamSchuljahrFilter">
                      <option value="">Alle Schuljahre</option>
                      <% if (schuljahre && schuljahre.length) { %>
                        <% schuljahre.forEach(schuljahr=> { %>
                          <option value="<%= schuljahr.id %>">
                            <%= schuljahr.name %>
                          </option>
                          <% }) %>
                            <% } else { %>
                              <% const schuljahrIds=[...new Set(schueler.map(s=>
                                s.schuljahr_id).filter(Boolean).sort())];
                                %>
                                <% schuljahrIds.forEach(id=> { %>
                                  <option value="<%= id %>">
                                    Schuljahr ID: <%= id %>
                                  </option>
                                  <% }) %>
                                    <% } %>
                    </select>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Verfügbare Teammitglieder</label>
                    <div class="card">
                      <div class="card-body p-3">
                        <p class="small text-muted mb-3 text-center" id="filterHint">
                          Verwenden Sie die Suchfilter oben, um Schüler anzuzeigen
                        </p>
                        <div class="available-members-container border rounded p-2 bg-light"
                          style="max-height: 200px; overflow-y: auto; display: none;" id="availableMembersContainer">
                          <div class="d-flex flex-wrap gap-1" id="availableMembers">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Teammitglieder auswählen</label>
                    <div class="drag-area border rounded p-3" id="teamDropZone"
                      style="min-height: 100px; background-color: #f8f9fa; display: flex; flex-wrap: wrap; align-items: flex-start; gap: 5px; transition: all 0.3s;">
                      <p class="text-muted text-center mb-0 w-100">Schüler hierher ziehen oder klicken</p>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <small class="text-muted me-auto" id="memberCount">0 Mitglieder ausgewählt</small>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>

                  <button type="button" class="btn btn-custom-safe" id="saveTeamBtn" style="display:none;">
                    <i class="bi bi-save"></i> Änderungen speichern
                  </button>
                  <button type="button" class="btn btn-custom-safe" id="createTeamBtn">
                    <i class="bi bi-plus"></i> Team erstellen
                  </button>
                </div>
              </div>
            </div>
          </div>

        </div>

        <input type="hidden" name="teams_data" id="teamsData" value="">

        <button type="submit" class="btn btn-custom-safe">Challenge speichern</button>
        <a href="/challenges" class="btn btn-secondary">Abbrechen</a>

        <div id="schuelerData" style="display: none;" data-schueler='<%= JSON.stringify(schueler) %>'></div>
  </form>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script src="/js/app/challengesFormLogic.js"> </script>