<% pageTitle=title %>


  <style>
    /* 1. Deine Basis-Regeln: Scrollen immer erlauben */
    body {
      overflow-y: scroll !important;
    }

    body.modal-open {
      overflow-y: auto !important;
      padding-right: 0 !important;
    }

    /* 2. NEU: Graues Overlay entfernen, wenn das Modal nicht aktiv ist */
    /* Falls Bootstrap vergisst, den Schatten zu löschen: */
    body:not(.modal-open) .modal-backdrop {
      display: none !important;
    }

    /* Falls das Modal zwar im HTML ist, aber nicht mehr angezeigt wird (.show fehlt) */
    .modal-backdrop.fade:not(.show) {
      display: none !important;
    }

    /* 3. Sicherheits-Fix: Klicks wieder freigeben */
    /* Manchmal liegt eine unsichtbare Schicht über der Seite */
    .modal-backdrop {
      pointer-events: none;
      /* Klicks gehen durch den Schatten hindurch */
    }

    .modal {
      pointer-events: none;
      /* Das Modal-Fenster selbst blockiert nichts mehr... */
    }

    .modal-dialog {
      pointer-events: auto;
      /* ...außer der Bereich, wo man wirklich tippt! */
    }

    /* Falls der offizielle Backdrop fehlt, lassen wir das Modal selbst den Hintergrund abdunkeln */
    #teamModal.show {
      background-color: rgba(0, 0, 0, 0.5) !important;
    }

    /* Verhindert "Doppel-Grau", falls doch beide da sind */
    #teamModal.show .modal-backdrop {
      display: none !important;
    }
  </style>


  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

  <h1 class="h4 mb-3">
    <%= title %>
  </h1>

  <form action="<%= action %>" method="POST" id="challengeForm">

    <% if (item.id) { %>
      <input type="hidden" name="_method" value="PUT">
      <% } %>

        <div class="row g-3">
          <div class="col-md-6">
            <div class="input-group mb-3">
              <span class="input-group-text">Aufgabenpaket *</span>
              <select name="aufgabenpaket_id" class="form-control" required>
                <option value="">Bitte wählen...</option>
                <% aufgabenpakete.forEach(paket=> { %>
                  <option value="<%= paket.id %>" <%=(Number(item.aufgabenpaket_id)===Number(paket.id)) ? 'selected'
                    : '' %>>
                    <%= paket.title %> (<%= paket.kategorie %>)
                  </option>
                  <% }) %>
              </select>
            </div>
          </div>

          <div class="col-md-3">
            <div class="input-group mb-3">
              <span class="input-group-text">Schuljahr</span>
              <select name="schuljahr_id" class="form-control" required>
                <option value="">Schuljahr wählen</option>
                <% schuljahre.forEach(jahr=> { %>
                  <option value="<%= jahr.id %>" <%=(item.schuljahr_id==jahr.id) ? 'selected' : '' %>>
                    <%= jahr.name %>
                  </option>
                  <% }) %>
              </select>
            </div>
          </div>

          <div class="col-md-3">
            <div class="input-group mb-3">
              <span class="input-group-text date-picker-icon"
                onclick="document.getElementById('dateInput').showPicker()">
                <i class="bi bi-calendar"></i>
              </span>
              <input type="date" class="form-control custom-date-input" name="abgabedatum" id="dateInput"
                value="<%= item.abgabedatum ? new Date(item.abgabedatum).toISOString().split('T')[0] : '' %>">
            </div>
          </div>

          <div class="input-group mb-3 align-top-stretch">
            <span class="input-group-text">Challenge-Zusatzinformationen</span>
            <textarea name="zusatzinfos" class="form-control" rows="3"
              placeholder="Spezielle Anweisungen oder Hinweise für diese Challenge">
        <%= item.zusatzinfos || '' %>
      </textarea>
          </div>
        </div>



        <h5 class="mb-3">Teams</h5>

        <div class="row g-2 mb-3 align-items-end">
          <div class="col-md-7">
            <label class="form-label small text-muted">Bereits vorhandene Teams hinzufügen</label>
            <select id="existingTeamSelect" class="form-select">
              <option value="">Team auswählen...</option>
              <% allTeams.forEach(t=> { %>
                <option value="<%= t.id %>" data-name="<%= t.name %>" data-members="<%= t.mitglieder_ids %>">
                  <%= t.name %>
                </option>
                <% }) %>
            </select>
          </div>
          <div class="col-md-5 d-flex gap-2">
            <button type="button" class="btn btn-outline-primary w-100" id="addExistingTeamBtn">
              <i class="bi bi-plus-lg"></i> Hinzufügen
            </button>
            <button type="button" id="openCreateTeamModal" data-bs-toggle="modal" data-bs-target="#teamModal"
              class="btn btn-custom-safe">
              + Team
            </button>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label mb-2">Zugeordnete Teams für diese Challenge:</label>
          <div id="teamsContainer" class="d-flex flex-wrap gap-2 mb-2"></div>
          <div id="noTeamsMessage" class="border rounded bg-light p-3 text-muted text-center w-100">
            <i class="bi bi-people me-2"></i> Noch keine Teams zugewiesen
          </div>
        </div>

        <%- include('../../partials/teamModal', { modalId: 'teamModal' }) %>


          <input type="hidden" name="teams_data" id="teamsData" value='<%- JSON.stringify(existingTeams || []) %>'>

          <button type="submit" class="btn btn-custom-safe">Challenge speichern</button>
          <a href="/challenges" class="btn btn-secondary">Abbrechen</a>

          <div id="schuelerData" class="d-none" data-schueler='<%= JSON.stringify(schueler) %>'></div>
  </form>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/app/teamModalLogic.js"></script>
  <script src="/js/app/challengesFormLogic.js"></script>