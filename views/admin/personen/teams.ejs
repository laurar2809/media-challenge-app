<% pageTitle="Team Übersicht" %>

<h1 class="h4 mb-4">Alle Teams</h1>




        <div class="mb-3">
          
            <button type="button" class="btn btn-custom-safe" data-bs-toggle="modal" data-bs-target="#teamModal"
              id="openCreateTeamModal">
              <i class="bi bi-plus-circle me-2"></i> Neues Team erstellen
            </button>
          


<!-- FILTER EINBINDEN -->
<%- include('../../partials/filter_search', {
    showKlasse: false,
    showSchuljahr: false,
    showSearch: true,

    // klasseSelectId: 'teamKlasseFilter',
    // schuljahrSelectId: 'teamSchuljahrFilter', 

    searchInputId: 'teamSearchInput',
    searchContainerId: 'teamSearchContainer',

    // activeKlasse: activeKlasse || 'alle',
    // activeSchuljahr: activeSchuljahr || 'alle',

    searchTerm: searchTerm || '',
    // klassen: klassen || [],
    // schuljahre: schuljahre || []
}) %>


<div class="table-responsive">
    <table class="table table-hover table align-middle m-0 table-light">
        <thead class="table-light">
            <tr>
                <th scope="col">Team Name</th>
                <th scope="col">Team ID</th>
                <!-- <th scope="col">Schuljahr</th> -->
                <th scope="col">Mitglieder (Anzahl)</th>
                <th scope="col">Mitglieder Details</th>
                <th scope="col" class="text-end">Aktionen</th>
            </tr>
        </thead>
        <tbody>
            <% if (teams && teams.length > 0) { %>
                <% teams.forEach(team => { %>
                    <tr>
                        <td class="fw-medium">
                            <i class="bi bi-people me-1"></i> <%= team.name %>
                        </td>
                        <td class="text-muted small"><%= team.id %></td>
                        <!-- <td><%= team.schuljahr_name || 'Nicht zugewiesen' %></td> -->
                        <td><%= team.mitglieder_count %></td>
                       <td>
    <% if (team.mitglieder_liste) { %>
        <span class="small text-muted">
            <i class="bi bi-person-fill"></i> <%= team.mitglieder_liste %>
        </span>
    <% } else { %>
        <span class="text-muted small">Keine Mitglieder</span>
    <% } %>
</td>
                        <td class="text-end">
                            <button type="button" class="btn btn-custom-details btn-sm" data-bs-toggle="modal" data-bs-target="#teamDetailModal<%= team.id %>">Details</button>
                        </td>
                    </tr>
                <% }) %>
            <% } else { %>
                <tr>
                    <td colspan="6" class="text-center py-4 text-muted">Keine Teams gefunden.</td>
                </tr>
            <% } %>
        </tbody>
    </table>
</div>
           <!-- RICHTIG -->
<%- include('../../partials/teamModal', { 
  modalId: 'teamModal', 
  schueler: schueler,
  klassen: klassen,
  schuljahre: schuljahre
}) %>



<div id="dataContainer" 
     data-schueler='<%- JSON.stringify(schueler) %>' 
     style="display:none;">
</div>

<script src="/js/app/teamModalLogic.js"></script>
<script src="/js/app/utils/filterUtils.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // 1. TEAM MODAL LOGIK STARTEN (Das hat gefehlt!)
    const dataContainer = document.getElementById('dataContainer');
    if (dataContainer) {
        const schuelerData = JSON.parse(dataContainer.dataset.schueler || '[]');
        
        // Hier "starten" wir die Klasse
        window.teamModalInstance = new TeamModal({
            modalId: 'teamModal',
            schueler: schuelerData,
            onSave: async (data) => {
                try {
                    const response = await fetch('/teams', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    if (result.success) {
                        location.reload(); // Seite neu laden nach Erfolg
                    } else {
                        alert("Fehler beim Speichern: " + result.error);
                    }
                } catch (err) {
                    console.error("Speicherfehler:", err);
                }
            }
        });
        console.log("Team-Modal erfolgreich initialisiert.");
    }

    // 2. SERVER-SUCHE LOGIK (Deine bestehende Suche für die Tabelle)
    const searchInput = document.getElementById('teamSearchInput');
    if (searchInput && searchInput.value.length > 0) {
        searchInput.focus();
        const val = searchInput.value;
        searchInput.value = '';
        searchInput.value = val;
    }

    if (searchInput && window.FilterUtils) {
        window.FilterUtils.initSearchWithBadge({
            input: searchInput,
            onChange: (query) => {
                const url = new URL(window.location.href);
                if (query) url.searchParams.set('search', query);
                else url.searchParams.delete('search');
                window.location.href = url.toString();
            }
        });
    }
});
</script>