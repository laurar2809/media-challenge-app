<% pageTitle = "Abgabe einreichen" %>
<link rel="stylesheet" href="/style.css">

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="h4 mb-1">
        <%= challenge.title %>
      </h2>
      <div class="d-flex align-items-center gap-2 text-muted">
        <span class="badge bg-secondary">
          <%= challenge.kategorie %>
        </span>
        <span class="small">
          <i class="bi bi-people"></i> Team: <%= team.name %>
        </span>
      </div>
    </div>
    <a href="/challenges/<%= challenge.id %>/detail" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-arrow-left"></i> Zurück
    </a>
  </div>

  <div class="alert alert-info mb-4">
    <% const currentStatus = abgabe ? abgabe.status : 'offen'; 
       let statusColor = 'primary'; 
       let statusText = currentStatus.charAt(0).toUpperCase() + currentStatus.slice(1); 
       if (currentStatus === 'eingereicht') statusColor = 'warning'; 
       else if (currentStatus === 'bewertet') statusColor = 'success'; 
       else if (currentStatus === 'abgelehnt') statusColor = 'danger'; 
       else if (currentStatus === 'offen') statusText = 'Noch nicht gestartet'; %>

    <div class="d-flex justify-content-between align-items-center">
      <div>
        <strong>Status:</strong>
        <span class="badge bg-<%= statusColor %> ms-2">
          <%= statusText %>
        </span>
      </div>
      <% if (abgabe && abgabe.updated_at) { %>
        <small class="text-muted">
          <i class="bi bi-clock"></i>
          Zuletzt bearbeitet: <%= new Date(abgabe.updated_at).toLocaleDateString('de-DE') %>
        </small>
      <% } %>
    </div>
  </div>

  <% const hasFinalStatus = abgabe && (abgabe.status === 'bewertet' || abgabe.status === 'abgelehnt'); 
     const isBewertet = abgabe && abgabe.status === 'bewertet'; 
     const isAbgelehnt = abgabe && abgabe.status === 'abgelehnt'; %>

  <% if (hasFinalStatus) { %>
    <% const bewertung = abgabe.bewertung; 
       const cardClass = isBewertet ? 'border-success' : 'border-danger';
       const bgClass = isBewertet ? 'bg-success-subtle' : 'bg-danger-subtle'; %>

    <div class="card <%= cardClass %> mb-4 shadow-sm">
      <div class="card-body <%= bgClass %>">
        <h5 class="card-title <%= isBewertet ? 'text-success' : 'text-danger' %>">
          <i class="bi <%= isBewertet ? 'bi-check-circle-fill' : 'bi-x-octagon-fill' %>"></i>
          <%= isBewertet ? 'Abgabe bewertet!' : 'Abgabe zur Überarbeitung zurückgesandt!' %>
        </h5>

        <% if (isAbgelehnt) { %>
          <p class="text-danger">Bitte prüfen Sie das Feedback des Lehrers unten und bearbeiten Sie Ihre Abgabe erneut.</p>
          <hr>
        <% } %>

        <% if (bewertung && bewertung.feedback) { %>
          <% if (isBewertet) { %>
            <div class="row">
              <div class="col-md-6 mb-2">
                <strong>Erreichte Punkte:</strong>
                <span class="fs-4 ms-2 text-primary">
                  <%= bewertung.punkte %>
                </span>
              </div>
              <div class="col-md-6 mb-2
