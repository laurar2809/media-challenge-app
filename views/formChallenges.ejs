<% pageTitle=title %>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<h1 class="h4 mb-3">
<%= title %>
</h1>
<form action="<%= action %>" method="POST" id="challengeForm">
  
 
 <div class="row g-3">
  <div class="col-md-6">
    <div class="input-group mb-3">
      <span class="input-group-text">Aufgabenpaket *</span>
      <select name="aufgabenpaket_id" class="form-control" required>
        <option value="">Bitte w√§hlen...</option>
        <% aufgabenpakete.forEach(paket => { %>
          <option value="<%= paket.id %>" 
            <%= (Number(item.aufgabenpaket_id) === Number(paket.id)) ? 'selected' : '' %>>
            <%= paket.title %> (<%= paket.kategorie %>)
          </option>
        <% }) %>
      </select>
    </div>
  </div>
  
  <!--Schuljahr ausw√§hlen-->
  <div class="col-md-3">
    <div class="input-group mb-3">
      <span class="input-group-text">Schuljahr</span>
      <select name="schuljahr_id" class="form-control" required>
        <option value="">Schuljahr w√§hlen</option>
        <% schuljahre.forEach(jahr => { %>
          <option value="<%= jahr.id %>" 
                  <%= (item.schuljahr_id == jahr.id) ? 'selected' : '' %>>
            <%= jahr.name %>
          </option>
        <% }) %>
      </select>
    </div>
  </div>


<!-- Abgabedatum -->
<div class="col-md-3">
  <div class="input-group mb-3">
    <span class="input-group-text" style="cursor: pointer;" onclick="document.getElementById('dateInput').showPicker()">
      <i class="bi bi-calendar"></i>
    </span>
    <input type="date" class="form-control custom-date-input" name="abgabedatum" id="dateInput"
           value="<%= item.abgabedatum ? new Date(item.abgabedatum).toISOString().split('T')[0] : '' %>">
  </div>
</div>

<!-- Zusatzinfos -->
  <div class="input-group mb-3 align-top-stretch">
    <span class="input-group-text">Challenge-Zusatzinformationen</span>
    <textarea name="zusatzinfos" class="form-control" rows="3" 
              placeholder="Spezielle Anweisungen oder Hinweise f√ºr diese Challenge"><%= item.zusatzinfos || '' %></textarea>
  </div>
  </div>

 <!-- TEAM MANAGEMENT SECTION -->
    <h5 class="mb-3">Teams</h5>

    <!-- Aktuelle Teams -->
    <input type="hidden" id="existingTeamsData" value='<%= JSON.stringify(existingTeam || []) %>'>

    <div class="mb-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <label class="form-label mb-0">Aktuelle Teams</label>
    <button type="button" class="btn btn-custom-safe" data-bs-toggle="modal" data-bs-target="#teamModal">
      <i class="bi bi-plus-circle"></i> Neues Team erstellen
    </button>
  </div>
  <div id="teamsContainer">
    <!-- Teams werden hier dynamisch hinzugef√ºgt -->
  </div>
  <div id="noTeamsMessage" class="border rounded bg-light p-3 text-muted d-flex align-items-center w-100">
    <i class="bi bi-people me-2"></i>
    Noch keine Teams verf√ºgbar
  </div>
</div>

    <!-- Team Erstellen Modal -->
<div class="modal fade" id="teamModal" tabindex="-1" aria-labelledby="teamModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="teamModalLabel">Neues Team erstellen</h5>
        <button type="button" class="btn-close" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Team Name -->
        <div class="mb-3">
          <label class="form-label">Team Name *</label>
          <input type="text" class="form-control" id="newTeamName" placeholder="Team Name eingeben...">
        </div>
        

        <div class="row g-2 mb-3">
          <div class="col-md-5">
            <input type="text" class="form-control form-control-sm" id="nameFilter" placeholder="Namen suchen...">
          </div>
          <div class="col-md-4">
            <select class="form-select form-select-sm" id="classFilter">
              <option value="">Alle Klassen</option>
              <% const klassen = [...new Set(schueler.map(s => s.klasse_name).filter(Boolean).sort())]; %>
              <% klassen.forEach(klasse => { %>
                <option value="<%= klasse %>"><%= klasse %></option>
              <% }) %>
            </select>
          </div>
          <div class="col-md-3">
            <div class="form-check form-switch mt-1">
              <input class="form-check-input" type="checkbox" id="onlyAvailableFilter">
              <label class="form-check-label small" for="onlyAvailableFilter">Nur verf√ºgbare</label>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Verf√ºgbare Teammitglieder</label>
          <div class="card">
            <div class="card-body p-3">
              <p class="small text-muted mb-3 text-center" id="filterHint">
                Verwenden Sie die Suchfilter oben, um Sch√ºler anzuzeigen
              </p>
              <div class="available-members-container border rounded p-2 bg-light" style="max-height: 200px; overflow-y: auto; display: none;" id="availableMembersContainer">
                <div class="d-flex flex-wrap gap-1" id="availableMembers">
                  <!-- Sch√ºler werden hier dynamisch eingef√ºgt -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Drop Zone f√ºr Team Mitglieder -->
        <div class="mb-3">
          <label class="form-label">Teammitglieder ausw√§hlen</label>
          <div class="drag-area border rounded p-3" id="teamDropZone" 
            style="min-height: 100px; background-color: #f8f9fa; display: flex; flex-wrap: wrap; align-items: flex-start; gap: 5px; transition: all 0.3s;">
            <p class="text-muted text-center mb-0 w-100">Sch√ºler hierher ziehen oder klicken</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <small class="text-muted me-auto" id="memberCount">0 Mitglieder ausgew√§hlt</small>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <button type="button" class="btn btn-custom-safe" id="createTeamBtn" data-bs-dismiss="modal">
            <i class="bi bi-plus"></i> Team erstellen
        </button>
      </div>
    </div>
  </div>
</div> 

  </div>

  <!-- Versteckte Inputs f√ºr Formular -->
  <input type="hidden" name="teams_data" id="teamsData" value="">

  

  <button type="submit" class="btn btn-custom-safe">Challenge speichern</button>
  <a href="/challenges" class="btn btn-secondary">Abbrechen</a>

  <div id="schuelerData" style="display: none;" data-schueler='<%= JSON.stringify(schueler) %>'></div>
</form>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {

  //  ZUERST alle DOM-Elemente definieren
  const availableMembers = document.getElementById('availableMembers');
  const teamDropZone = document.getElementById('teamDropZone');
  const teamsContainer = document.getElementById('teamsContainer');
  const createTeamBtn = document.getElementById('createTeamBtn');
  const teamsDataInput = document.getElementById('teamsData');
  const newTeamName = document.getElementById('newTeamName');
  const nameFilter = document.getElementById('nameFilter');
  const classFilter = document.getElementById('classFilter');
  const calendarTrigger = document.getElementById('calendarTrigger');
  const dateInput = document.getElementById('dateInput');
  const filterHint = document.getElementById('filterHint');
  const onlyAvailableFilter = document.getElementById('onlyAvailableFilter');
  
  document.getElementById('teamModal')?.addEventListener('hidden.bs.modal', () => {
    console.log('üî• Modal wurde vollst√§ndig geschlossen!');
  });

  if (calendarTrigger && dateInput) {
    calendarTrigger.addEventListener('click', function() {
      dateInput.showPicker(); // √ñffnet den nativen Date-Picker
    });
    
    // Optional: Auch das Input-Feld klickbar machen f√ºr bessere UX
    dateInput.addEventListener('click', function() {
      this.showPicker();
    });
  }

  //  Teams aus verstecktem Input-Feld lesen
  const existingTeamsInput = document.getElementById('existingTeamsData');
  const existingTeamsJSON = existingTeamsInput ? existingTeamsInput.value : '[]';

  // Sch√ºler-Daten aus dem versteckten Container lesen
  const schuelerDataElement = document.getElementById('schuelerData');
  const schuelerListe = schuelerDataElement ? JSON.parse(schuelerDataElement.dataset.schueler) : [];
  
  let teams = [];  
  let teamCounter = 1;

  // Teams Daten f√ºr Formular aktualisieren (GANZ EINFACH)
  function updateTeamsData() {
    teamsDataInput.value = JSON.stringify(teams);
  }

  if (existingTeamsJSON && existingTeamsJSON !== '[]') {
    try {
      teams = JSON.parse(existingTeamsJSON);
      teamCounter = teams.length + 1;
      renderTeams();
      updateTeamsData(); // AUFRUF 1: Beim Laden
      console.log(' Vorhandene Teams geladen:', teams);
    } catch (e) {
      console.error('Fehler beim Parsen der Teams:', e);
    }
  }
   renderTeams();

  // Drag & Drop Funktionem

  teamDropZone.addEventListener('dragover', e => {
    e.preventDefault();
    teamDropZone.style.backgroundColor = '#e9ecef';
    teamDropZone.style.borderColor = '#007bff';
  });

  teamDropZone.addEventListener('dragleave', e => {
    e.preventDefault();
    teamDropZone.style.backgroundColor = '#f8f9fa';
    teamDropZone.style.borderColor = '#dee2e6';
  });

  teamDropZone.addEventListener('drop', e => {
    e.preventDefault();
    teamDropZone.style.backgroundColor = '#f8f9fa';
    teamDropZone.style.borderColor = '#dee2e6';
    const memberId = e.dataTransfer.getData('text/plain');
    const member = availableMembers.querySelector(`[data-id="${memberId}"]`);
    if (member) {
      addMemberToDropZone(member);
    }
  });


  // Mitglied zur DropZone hinzuf√ºgen
  function addMemberToDropZone(memberElement) {
    const memberId = memberElement.dataset.id;
    
    // Pr√ºfen ob Mitglied bereits in DropZone
    if (!teamDropZone.querySelector(`[data-id="${memberId}"]`)) {
      const teamMember = memberElement.cloneNode(true);
      teamMember.classList.add('drag-item');
      teamMember.classList.remove('btn-custom-safe');
      teamMember.classList.add('btn-custom-safe', 'text-white');
      teamMember.style.cursor = 'default';
      
      // Entfernen-Button
      const removeBtn = document.createElement('span');
      removeBtn.innerHTML = ' √ó';
      removeBtn.style.cursor = 'pointer';
      removeBtn.style.marginLeft = '5px';
      removeBtn.style.fontWeight = 'bold';
      removeBtn.onclick = function(e) {
        e.stopPropagation();
        teamMember.remove();
        updatePlaceholder();
        updateMemberCounter();
        filterMembers(); // Filter neu anwenden nach Entfernen
      };
      
      teamMember.appendChild(removeBtn);
      
      // Platzhalter entfernen
      const placeholder = teamDropZone.querySelector('p');
      if (placeholder) placeholder.remove();
      
      teamDropZone.appendChild(teamMember);
      updateMemberCounter();
      
      // Optional: Mitglied in der verf√ºgbaren Liste als ausgew√§hlt markieren
      memberElement.classList.add('opacity-50');
    }
  }
  // Platzhalter aktualisieren
  function updatePlaceholder() {
    if (teamDropZone.children.length === 0) {
      const placeholder = document.createElement('p');
      placeholder.className = 'text-muted text-center mb-0 w-100';
      placeholder.textContent = 'Sch√ºler hierher ziehen oder klicken';
      teamDropZone.appendChild(placeholder);
    }
  }

//Team erstellen
createTeamBtn.addEventListener('click', function() {
    const teamName = newTeamName.value.trim();
    
    // Validierung
    if (!teamName) {
        alert('Bitte geben Sie einen Team Namen ein!');
        // Modal nicht schlie√üen bei Fehler
        return;
    }
    
    const members = Array.from(teamDropZone.querySelectorAll('.drag-item[data-id]'));
    if (members.length === 0) {
        alert('Bitte f√ºgen Sie mindestens ein Teammitglied hinzu!');
        // Modal nicht schlie√üen bei Fehler
        return;
    }
    
    // Team erstellen
    const team = {
        id: 'team-' + teamCounter++,
        name: teamName,
        mitglieder: members.map(member => ({
            id: parseInt(member.dataset.id),
            vorname: member.dataset.vorname,
            nachname: member.dataset.nachname,
            klasse: member.dataset.klasse
        }))
    };
    
    teams.push(team);
    renderTeams();
    clearTeamForm();
    updateTeamsData();
    
});

// Teams anzeigen
function renderTeams() {
  const teamsContainer = document.getElementById('teamsContainer');
  const noTeamsMessage = document.getElementById('noTeamsMessage');
  
  console.log('renderTeams aufgerufen, teams:', teams.length);
  
  if (teams.length > 0) {
    // Teams vorhanden - K√§stchen ausblenden
    if (noTeamsMessage) {
      noTeamsMessage.style.display = 'none';
    }
    teamsContainer.innerHTML = '';
    
    teams.forEach((team, index) => {
      const teamCard = document.createElement('div');
      teamCard.className = 'card mb-2';
      teamCard.innerHTML = `
        <div class="card-body p-2">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="card-title mb-0">${team.name}</h6>
            <button type="button" class="btn btn-sm remove-team" data-index="${index}">
              <i class="bi bi-x-circle"></i>
            </button>
          </div>
          <div class="mt-1">
            ${team.mitglieder.map(m => 
              `<span class="badge bg-secondary me-1">${m.vorname} ${m.nachname}</span>`
            ).join('')}
          </div>
        </div>
      `;
      teamsContainer.appendChild(teamCard);
    });

    // Event Listener f√ºr Remove Buttons
    teamsContainer.querySelectorAll('.remove-team').forEach(btn => {
      btn.addEventListener('click', function() {
        const index = parseInt(this.dataset.index);
        teams.splice(index, 1);
        renderTeams();
        updateTeamsData();
        filterMembers();
      });
    });
  } else {
    // Keine Teams - K√§stchen anzeigen
    if (noTeamsMessage) {
      noTeamsMessage.style.display = 'flex';
    }
    teamsContainer.innerHTML = '';
  }
  
  filterMembers();
}

  // Team Formular zur√ºcksetzen
  function clearTeamForm() {
  newTeamName.value = '';
  teamDropZone.innerHTML = '<p class="text-muted text-center mb-0 w-100">Sch√ºler hierher ziehen oder klicken</p>';
  updateMemberCounter(); //Counter zur√ºcksetzen
  
}

// Filter Funktionen
function filterMembers() {
  const nameValue = nameFilter.value.toLowerCase().trim();
  const classValue = classFilter.value;
  const onlyAvailable = document.getElementById('onlyAvailableFilter')?.checked;
  
  const availableMembersContainer = document.getElementById('availableMembersContainer');
  const availableMembers = document.getElementById('availableMembers');
  
  
  const hasActiveFilter = nameValue || classValue;
  
  if (hasActiveFilter) {
    availableMembersContainer.style.display = 'block';
    filterHint.style.display = 'none'; // Hinweis ausblenden
  } else {
    availableMembersContainer.style.display = 'none';
    filterHint.style.display = 'block'; // Hinweis anzeigen
    availableMembers.innerHTML = '';
    return;
  }
  
  availableMembers.innerHTML = '';
  let hasResults = false;
  
  schuelerListe.forEach(s => {
    const vorname = (s.vorname || '').toLowerCase();
    const nachname = (s.nachname || '').toLowerCase();
    const klasse = s.klasse_name || s.klasse || '';
    const memberId = s.id;
    
    // Pr√ºfen ob Mitglied bereits in einem Team ist
    const isInTeam = teams.some(team => 
      team.mitglieder.some(m => m.id == memberId)
    );
    
    //UNABH√ÑNGIGE Filter
    const nameMatch = !nameValue || vorname.includes(nameValue) || nachname.includes(nameValue);
    const classMatch = !classValue || klasse === classValue;
    const availableMatch = !onlyAvailable || !isInTeam;
    
    //Kombinierte Filterung
    if (nameMatch && classMatch && availableMatch) {
      hasResults = true;
      
      const memberElement = document.createElement('div');
      memberElement.className = `member-chip drag-item available-member ${isInTeam ? 'opacity-50' : ''}`;
      memberElement.setAttribute('data-id', s.id);
      memberElement.setAttribute('data-klasse', klasse);
      memberElement.setAttribute('data-vorname', s.vorname);
      memberElement.setAttribute('data-nachname', s.nachname);
      memberElement.setAttribute('draggable', 'true');
      memberElement.textContent = `${s.vorname} ${s.nachname} (${klasse})`;
      
      memberElement.addEventListener('dragstart', function(e) {
        e.dataTransfer.setData('text/plain', this.dataset.id);
      });
      
      memberElement.addEventListener('click', function() {
        if (!this.classList.contains('opacity-50')) {
          addMemberToDropZone(this);
        }
      });
      
      availableMembers.appendChild(memberElement);
    }
  });
  
  if (!hasResults) {
    availableMembers.innerHTML = '<p class="text-muted text-center w-100">Keine passenden Mitglieder gefunden</p>';
  }
}

//Team Counter
function updateMemberCounter() {
  const members = teamDropZone.querySelectorAll('.drag-item[data-id]');
  const countElement = document.getElementById('memberCount');
  if (countElement) {
    const count = members.length;
    countElement.textContent = `${count} Mitglieder ausgew√§hlt`;
    countElement.className = count > 0 ? 'custom-selected-count small fw-bold' : 'text-muted small';
    console.log('Counter updated:', count, 'members'); // Debug
  }
}


// Event Listener f√ºr Filter
let filterTimeout;

if (nameFilter) {
  nameFilter.addEventListener('input', function() {
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
      console.log('Name filter input:', this.value);
      filterMembers();
    }, 200); 
  });
}

if (classFilter) {
  classFilter.addEventListener('change', function() {
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
      console.log('Class filter changed:', this.value);
      filterMembers();
    }, 200);
  });
}

document.getElementById('availableMembersContainer').addEventListener('dragstart', function(e) {
  if (e.target.classList.contains('drag-item')) {
    e.dataTransfer.setData('text/plain', e.target.dataset.id);
  }
});

// Event Listener f√ºr "Nur verf√ºgbare" Checkbox
if (onlyAvailableFilter) {
  onlyAvailableFilter.addEventListener('change', function() {
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
      console.log('Only available changed:', this.checked);
      filterMembers();
    }, 200); // ‚úÖ 200ms Verz√∂gerung
  });
}

  // Formular Submit validieren
  document.getElementById('challengeForm').addEventListener('submit', function(e) {
    if (teams.length === 0) {
      e.preventDefault();
      alert('Bitte erstellen Sie mindestens ein Team f√ºr diese Challenge!');
      return;
    }
  });

  // Modal-Event-Listener f√ºr Reset beim √ñffnen
  document.getElementById('teamModal').addEventListener('show.bs.modal', function() {
    clearTeamForm();
    nameFilter.value = '';
    classFilter.value = '';
    if (onlyAvailableFilter) onlyAvailableFilter.checked = false;
    filterMembers();
});


  // Initialisierung
  updatePlaceholder();
  updateMemberCounter(); // Counter initialisieren
  filterMembers(); // Filter initial anwenden


});

document.querySelectorAll('.modal-backdrop').length
document.body.classList.contains('modal-open')

</script>