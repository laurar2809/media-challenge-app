<% pageTitle=title %>

<h1 class="h4 mb-3">
  <%= title %>
</h1>
<form action="<%= action %>" method="POST" id="challengeForm">
  
  <!-- Aufgabenpaket Auswahl -->
  <div class="mb-3">
    <label class="form-label">Aufgabenpaket *</label>
    <select name="aufgabenpaket_id" class="form-control" required>
      <option value="">Bitte wählen...</option>
      <% aufgabenpakete.forEach(paket => { %>
        <option value="<%= paket.id %>" 
          <%= (Number(item.aufgabenpaket_id) === Number(paket.id)) ? 'selected' : '' %>>
          <%= paket.title %> (<%= paket.kategorie %>)
        </option>
      <% }) %>
    </select>
  </div>

  <!-- SCHULJAHR AUSWAHL - NEU -->
<div class="mb-3">
  <label class="form-label">Schuljahr *</label>
  <select name="schuljahr_id" class="form-control" required>
    <option value="">Schuljahr wählen</option>
    <% schuljahre.forEach(jahr => { %>
      <option value="<%= jahr.id %>" 
              <%= (item.schuljahr_id == jahr.id) ? 'selected' : '' %>>
        <%= jahr.name %>
      </option>
    <% }) %>
  </select>
</div>

 <!-- TEAM MANAGEMENT SECTION -->
  <div class="mb-4 p-3 border rounded bg-light">
    <h5 class="mb-3">Team Management</h5>
    
    

    <!-- Team Erstellen Bereich -->
    <div class="mb-3">
      <label class="form-label">Neues Team erstellen</label>
      <div class="card">
        <div class="card-body">
          <!-- Team Name -->
          <div class="mb-3">
            <label class="form-label small">Team Name *</label>
            <input type="text" class="form-control form-control-sm" id="newTeamName" placeholder="Team Name eingeben...">
          </div>
          
          <!-- Team Beschreibung -->
          <div class="mb-3">
            <label class="form-label small">Team Beschreibung</label>
            <textarea class="form-control form-control-sm" id="newTeamDescription" rows="2" placeholder="Optionale Beschreibung..."></textarea>
          </div>

          <div class="row g-2 mb-3">
    <div class="col-md-5">
      <input type="text" class="form-control form-control-sm" id="nameFilter" placeholder="Namen suchen...">
    </div>

    <div class="col-md-4">
      <select class="form-select form-select-sm" id="classFilter">
        <option value="">Alle Klassen</option>
        <% const klassen = [...new Set(schueler.map(s => s.klasse_name).filter(Boolean).sort())]; %>
        <% klassen.forEach(klasse => { %>
          <option value="<%= klasse %>"><%= klasse %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-3">
      <div class="form-check form-switch mt-1">
        <input class="form-check-input" type="checkbox" id="onlyAvailableFilter">
        <label class="form-check-label small" for="onlyAvailableFilter">Nur verfügbare</label>
      </div>
    </div>
  </div>

    <div class="mb-3">
    <label class="form-label">Verfügbare Teammitglieder</label>
    <div class="card">
      <div class="card-body p-3">
        <p class="small text-muted mb-3 text-center" id="filterHint">
        Verwenden Sie die Suchfilter oben, um Schüler anzuzeigen
        </p>
        <div class="available-members-container border rounded p-2 bg-light" style="max-height: 200px; overflow-y: auto; display: none;" id="availableMembersContainer">
          <div class="d-flex flex-wrap gap-1" id="availableMembers">
            <!-- Schüler werden hier dynamisch eingefügt -->
          </div>
        </div>
      </div>
    </div>
</div>

    <!-- Drop Zone für Team Mitglieder -->
    <div class="mb-3">
      <label class="form-label small">Teammitglieder auswählen</label>
      <div class="drag-area border rounded p-3" id="teamDropZone" 
        style="min-height: 100px; background-color: #f8f9fa; display: flex; flex-wrap: wrap; align-items: flex-start; gap: 5px; transition: all 0.3s;">
        <p class="text-muted text-center mb-0 w-100">Schüler hierher ziehen oder klicken</p>
      </div>
    </div>
        
          
          <!-- Team erstellen Button -->
          <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted" id="memberCount">0 Mitglieder ausgewählt</small>
          <button type="button" class="btn btn-success btn-sm btn-custom-safe" id="createTeamBtn">
            <i class="fas fa-plus"></i> Team erstellen
          </button>
        </div>
        </div>
      </div>
    </div>

    <!-- Aktuelle Teams -->
    <input type="hidden" id="existingTeamsData" value='<%= JSON.stringify(existingTeam || []) %>'>
    
    <div class="mb-3">
      <label class="form-label">Aktuelle Teams</label>
      <div id="teamsContainer">
        <!-- Teams werden hier dynamisch hinzugefügt -->
      </div>
    </div>

  </div>

  <!-- Versteckte Inputs für Formular -->
  <input type="hidden" name="teams_data" id="teamsData" value="">

  <!-- Zusatzinfos -->
  <div class="mb-3">
    <label class="form-label">Challenge-Zusatzinformationen</label>
    <textarea name="zusatzinfos" class="form-control" rows="3" 
              placeholder="Spezielle Anweisungen oder Hinweise für diese Challenge"><%= item.zusatzinfos || '' %></textarea>
  </div>

  <!-- Abgabedatum -->
<div class="mb-3">
  <label class="form-label">Abgabedatum</label>
  <input type="date" name="abgabedatum" class="form-control" 
         value="<%= item.abgabedatum ? new Date(item.abgabedatum).toISOString().split('T')[0] : '' %>">
</div>

  <button type="submit" class="btn btn-custom-safe">Challenge speichern</button>
  <a href="/challenges" class="btn btn-secondary">Abbrechen</a>

  <div id="schuelerData" style="display: none;" data-schueler='<%= JSON.stringify(schueler) %>'></div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
  //  ZUERST alle DOM-Elemente definieren
  const availableMembers = document.getElementById('availableMembers');
  const teamDropZone = document.getElementById('teamDropZone');
  const teamsContainer = document.getElementById('teamsContainer');
  const createTeamBtn = document.getElementById('createTeamBtn');
  const teamsDataInput = document.getElementById('teamsData');
  const newTeamName = document.getElementById('newTeamName');
  const newTeamDescription = document.getElementById('newTeamDescription');
  const nameFilter = document.getElementById('nameFilter');
  const classFilter = document.getElementById('classFilter');

  //  Teams aus verstecktem Input-Feld lesen
  const existingTeamsInput = document.getElementById('existingTeamsData');
  const existingTeamsJSON = existingTeamsInput ? existingTeamsInput.value : '[]';

  // Schüler-Daten aus dem versteckten Container lesen
  const schuelerDataElement = document.getElementById('schuelerData');
  const schuelerListe = schuelerDataElement ? JSON.parse(schuelerDataElement.dataset.schueler) : [];
  
  let teams = [];  
  let teamCounter = 1;

  // Teams Daten für Formular aktualisieren (GANZ EINFACH)
  function updateTeamsData() {
    teamsDataInput.value = JSON.stringify(teams);
  }

  if (existingTeamsJSON && existingTeamsJSON !== '[]') {
    try {
      teams = JSON.parse(existingTeamsJSON);
      teamCounter = teams.length + 1;
      renderTeams();
      updateTeamsData(); // AUFRUF 1: Beim Laden
      console.log(' Vorhandene Teams geladen:', teams);
    } catch (e) {
      console.error('Fehler beim Parsen der Teams:', e);
    }
  }

  // Drag & Drop Funktionem

  teamDropZone.addEventListener('dragover', e => {
    e.preventDefault();
    teamDropZone.style.backgroundColor = '#e9ecef';
    teamDropZone.style.borderColor = '#007bff';
  });

  teamDropZone.addEventListener('dragleave', e => {
    e.preventDefault();
    teamDropZone.style.backgroundColor = '#f8f9fa';
    teamDropZone.style.borderColor = '#dee2e6';
  });

  teamDropZone.addEventListener('drop', e => {
    e.preventDefault();
    teamDropZone.style.backgroundColor = '#f8f9fa';
    teamDropZone.style.borderColor = '#dee2e6';
    const memberId = e.dataTransfer.getData('text/plain');
    const member = availableMembers.querySelector(`[data-id="${memberId}"]`);
    if (member) {
      addMemberToDropZone(member);
    }
  });


  // Mitglied zur DropZone hinzufügen
  function addMemberToDropZone(memberElement) {
    const memberId = memberElement.dataset.id;
    
    // Prüfen ob Mitglied bereits in DropZone
    if (!teamDropZone.querySelector(`[data-id="${memberId}"]`)) {
      const teamMember = memberElement.cloneNode(true);
      teamMember.classList.remove('btn-outline-primary');
      teamMember.classList.add('bg-primary', 'text-white');
      teamMember.style.cursor = 'default';
      
      // Entfernen-Button
      const removeBtn = document.createElement('span');
      removeBtn.innerHTML = ' ×';
      removeBtn.style.cursor = 'pointer';
      removeBtn.style.marginLeft = '5px';
      removeBtn.style.fontWeight = 'bold';
      removeBtn.onclick = function(e) {
        e.stopPropagation();
        teamMember.remove();
        updatePlaceholder();
        updateMemberCounter();
        filterMembers(); // Filter neu anwenden nach Entfernen
      };
      
      teamMember.appendChild(removeBtn);
      
      // Platzhalter entfernen
      const placeholder = teamDropZone.querySelector('p');
      if (placeholder) placeholder.remove();
      
      teamDropZone.appendChild(teamMember);
      updateMemberCounter();
      
      // Optional: Mitglied in der verfügbaren Liste als ausgewählt markieren
      memberElement.classList.add('opacity-50');
    }
  }
  // Platzhalter aktualisieren
  function updatePlaceholder() {
    if (teamDropZone.children.length === 0) {
      const placeholder = document.createElement('p');
      placeholder.className = 'text-muted text-center mb-0 w-100';
      placeholder.textContent = 'Schüler hierher ziehen oder klicken';
      teamDropZone.appendChild(placeholder);
    }
  }

  // Team erstellen
  createTeamBtn.addEventListener('click', function() {
    const teamName = newTeamName.value.trim();
    const teamDescription = newTeamDescription.value.trim();
    
    // Validierung
    if (!teamName) {
      alert('Bitte geben Sie einen Team Namen ein!');
      return;
    }
    
    const members = Array.from(teamDropZone.querySelectorAll('.drag-item'));
    if (members.length === 0) {
      alert('Bitte fügen Sie mindestens ein Teammitglied hinzu!');
      return;
    }
    
    // Team erstellen
    const team = {
      id: 'team-' + teamCounter++,
      name: teamName,
      beschreibung: teamDescription,
      mitglieder: members.map(member => ({
        id: parseInt(member.dataset.id),
        vorname: member.dataset.vorname,
        nachname: member.dataset.nachname,
        klasse: member.dataset.klasse
      }))
    };
    
    teams.push(team);
    renderTeams();
    clearTeamForm();
    updateTeamsData(); // ✅ AUFRUF 2: Beim Erstellen
  });

  // Teams anzeigen
  function renderTeams() {
    teamsContainer.innerHTML = '';
    
    teams.forEach((team, index) => {
      const teamCard = document.createElement('div');
      teamCard.className = 'card mb-2';
      teamCard.innerHTML = `
        <div class="card-body p-2">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="card-title mb-0">${team.name}</h6>
            <button type="button" class="btn btn-outline-danger btn-sm remove-team" data-index="${index}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          ${team.beschreibung ? `<p class="small text-muted mb-1">${team.beschreibung}</p>` : ''}
          <div class="mt-1">
            ${team.mitglieder.map(m => 
              `<span class="badge bg-secondary me-1">${m.vorname} ${m.nachname}</span>`
            ).join('')}
          </div>
        </div>
      `;
      teamsContainer.appendChild(teamCard);
    });

    // Event Listener für Remove Buttons
    teamsContainer.querySelectorAll('.remove-team').forEach(btn => {
      btn.addEventListener('click', function() {
        const index = parseInt(this.dataset.index);
        teams.splice(index, 1);
        renderTeams();
        updateTeamsData(); // ✅ AUFRUF 3: Beim Löschen
        filterMembers();
      });
    });
    filterMembers();
  }

  // Team Formular zurücksetzen
  function clearTeamForm() {
  newTeamName.value = '';
  newTeamDescription.value = '';
  teamDropZone.innerHTML = '<p class="text-muted text-center mb-0 w-100">Schüler hierher ziehen oder klicken</p>';
  updateMemberCounter(); //Counter zurücksetzen
}

// Filter Funktionen
function filterMembers() {
  const nameValue = nameFilter.value.toLowerCase().trim();
  const classValue = classFilter.value;
  const onlyAvailable = document.getElementById('onlyAvailableFilter')?.checked;
  
  const availableMembersContainer = document.getElementById('availableMembersContainer');
  const availableMembers = document.getElementById('availableMembers');
  
  
  const hasActiveFilter = nameValue || classValue;
  
  if (hasActiveFilter) {
    availableMembersContainer.style.display = 'block';
    filterHint.style.display = 'none'; // Hinweis ausblenden
  } else {
    availableMembersContainer.style.display = 'none';
    filterHint.style.display = 'block'; // Hinweis anzeigen
    availableMembers.innerHTML = '';
    return;
  }
  
  availableMembers.innerHTML = '';
  let hasResults = false;
  
  schuelerListe.forEach(s => {
    const vorname = (s.vorname || '').toLowerCase();
    const nachname = (s.nachname || '').toLowerCase();
    const klasse = s.klasse_name || s.klasse || '';
    const memberId = s.id;
    
    // Prüfen ob Mitglied bereits in einem Team ist
    const isInTeam = teams.some(team => 
      team.mitglieder.some(m => m.id == memberId)
    );
    
    //UNABHÄNGIGE Filter
    const nameMatch = !nameValue || vorname.includes(nameValue) || nachname.includes(nameValue);
    const classMatch = !classValue || klasse === classValue;
    const availableMatch = !onlyAvailable || !isInTeam;
    
    //Kombinierte Filterung
    if (nameMatch && classMatch && availableMatch) {
      hasResults = true;
      
      const memberElement = document.createElement('div');
      memberElement.className = `btn btn-outline-primary btn-sm drag-item available-member ${isInTeam ? 'opacity-50' : ''}`;
      memberElement.setAttribute('data-id', s.id);
      memberElement.setAttribute('data-klasse', klasse);
      memberElement.setAttribute('data-vorname', s.vorname);
      memberElement.setAttribute('data-nachname', s.nachname);
      memberElement.setAttribute('draggable', 'true');
      memberElement.textContent = `${s.vorname} ${s.nachname} (${klasse})`;
      
      memberElement.addEventListener('dragstart', function(e) {
        e.dataTransfer.setData('text/plain', this.dataset.id);
      });
      
      memberElement.addEventListener('click', function() {
        if (!this.classList.contains('opacity-50')) {
          addMemberToDropZone(this);
        }
      });
      
      availableMembers.appendChild(memberElement);
    }
  });
  
  if (!hasResults) {
    availableMembers.innerHTML = '<p class="text-muted text-center w-100">Keine passenden Mitglieder gefunden</p>';
  }
}

//Team Counter
function updateMemberCounter() {
  const members = teamDropZone.querySelectorAll('.drag-item[data-id]');
  const countElement = document.getElementById('memberCount');
  if (countElement) {
    const count = members.length;
    countElement.textContent = `${count} Mitglieder ausgewählt`;
    countElement.className = count > 0 ? 'text-success small fw-bold' : 'text-muted small';
    console.log('Counter updated:', count, 'members'); // Debug
  }
}


// Event Listener für Filter
let filterTimeout;

if (nameFilter) {
  nameFilter.addEventListener('input', function() {
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
      console.log('Name filter input:', this.value);
      filterMembers();
    }, 200); 
  });
}

if (classFilter) {
  classFilter.addEventListener('change', function() {
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
      console.log('Class filter changed:', this.value);
      filterMembers();
    }, 200);
  });
}

document.getElementById('availableMembersContainer').addEventListener('dragstart', function(e) {
  if (e.target.classList.contains('drag-item')) {
    e.dataTransfer.setData('text/plain', e.target.dataset.id);
  }
});

// Event Listener für "Nur verfügbare" Checkbox
const onlyAvailableFilter = document.getElementById('onlyAvailableFilter');
if (onlyAvailableFilter) {
  onlyAvailableFilter.addEventListener('change', function() {
    clearTimeout(filterTimeout);
    filterTimeout = setTimeout(() => {
      console.log('Only available changed:', this.checked);
      filterMembers();
    }, 200); // ✅ 200ms Verzögerung
  });
}

  // Formular Submit validieren
  document.getElementById('challengeForm').addEventListener('submit', function(e) {
    if (teams.length === 0) {
      e.preventDefault();
      alert('Bitte erstellen Sie mindestens ein Team für diese Challenge!');
      return;
    }
  });

  // Initialisierung
  updatePlaceholder();
  updateMemberCounter(); // Counter initialisieren
  filterMembers(); // Filter initial anwenden

});
</script>