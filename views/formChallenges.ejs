<% pageTitle=title %>
<h1 class="h4 mb-3">
  <%= title %>
</h1>
<form action="<%= action %>" method="POST" id="challengeForm">
  
  <!-- Aufgabenpaket Auswahl -->
  <div class="mb-3">
    <label class="form-label">Aufgabenpaket *</label>
    <select name="aufgabenpaket_id" class="form-control" required>
      <option value="">Bitte wählen...</option>
      <% aufgabenpakete.forEach(paket => { %>
        <option value="<%= paket.id %>" 
          <%= (Number(item.aufgabenpaket_id) === Number(paket.id)) ? 'selected' : '' %>>
          <%= paket.title %> (<%= paket.kategorie %>)
        </option>
      <% }) %>
    </select>
  </div>

  <!-- Team Name -->
  <div class="mb-3">
    <label class="form-label">Team Name *</label>
  </div>

  <!-- Team Beschreibung -->
  <div class="mb-3">
    <label class="form-label">Team Beschreibung</label>
    <textarea name="team_beschreibung" class="form-control" rows="2" 
              placeholder="Kurze Beschreibung des Teams"><%= item.team_beschreibung || '' %></textarea>
  </div>

  <!-- Schüler Auswahl (Mehrfachauswahl) -->
  <!-- Schüler Auswahl als Checkbox-Liste -->
<!-- Filter Section oben nach dem <h1> einfügen -->
<div class="filter-section mb-4 p-3 border rounded bg-light">
  <div class="row g-2">
    <div class="col-md-6">
      <label class="form-label small">Nach Namen filtern</label>
      <input type="text" class="form-control form-control-sm" id="nameFilter" placeholder="Namen suchen...">
    </div>
    <div class="col-md-6">
      <label class="form-label small">Nach Klasse filtern</label>
      <select class="form-select form-select-sm" id="classFilter">
        <option value="">Alle Klassen</option>
        <% const klassen = [...new Set(schueler.map(s => s.klasse_name).filter(Boolean))]; %>
        <% klassen.forEach(klasse => { %>
          <option value="<%= klasse %>"><%= klasse %></option>
        <% }) %>
      </select>
    </div>
  </div>

  <div class="mb-3">
  <label class="form-label">Verfügbare Teammitglieder</label>
  <div class="d-flex flex-wrap gap-2" id="availableMembers">
    <% schueler.forEach(s => { %>
      <div class="btn btn-outline-primary btn-sm drag-item" 
           data-id="<%= s.id %>" data-klasse="<%= s.klasse_name %>" draggable="true">
        <%= s.vorname %> <%= s.nachname %><% if (s.klasse_name) { %> - <%= s.klasse_name %><% } %>
      </div>
    <% }) %>
  </div>
</div>
  
<div class="mb-3">
  <label class="form-label">Teams</label>
  

  <div id="teamsContainer">
    <div class="team-card card mb-2" data-team-id="1">
      <div class="card-body p-2">
        <div class="drag-area border rounded p-3 mb-3" id="teamDropZone" 
        style="min-height: 100px; background-color: #f8f9fa; display: flex; flex-wrap: wrap; align-items: flex-start; gap: 5px;">
        <p class="text-muted text-center mb-0 w-100">Ziehen Sie Teammitglieder hierher (für schnelles Testen)</p>
        </div>
        <input type="hidden" name="teams[]" value="">
      </div>
    </div>
  </div>
</div>

<button type="button" class="btn btn-success btn-sm mb-2" id="addTeamBtn">
  <i class="fas fa-plus"></i> Team hinzufügen
</button>
  
  <!-- Verstecktes Input für Formular -->
  <input type="hidden" name="schueler_ids" id="selectedSchuelerIds" value="<%= item.schueler_ids ? item.schueler_ids.join(',') : '' %>">
  
</div>

  <!-- Zusatzinfos -->
  <div class="mb-3">
    <label class="form-label">Challenge-Zusatzinformationen</label>
    <textarea name="zusatzinfos" class="form-control" rows="3" 
              placeholder="Spezielle Anweisungen oder Hinweise für diese Challenge"><%= item.zusatzinfos || '' %></textarea>
  </div>

  <!-- Abgabedatum -->
  <div class="mb-3">
    <label class="form-label">Abgabedatum</label>
    <input type="date" name="abgabedatum" class="form-control" value="<%= item.abgabedatum || '' %>">
  </div>

  <button type="submit" class="btn btn-custom-safe">Challenge erstellen</button>
  <a href="/challenges" class="btn btn-secondary">Abbrechen</a>
</form>

<script>

  const teamsContainer = document.getElementById('teamsContainer');
  const addTeamBtn = document.getElementById('addTeamBtn');
  let teamCounter = 1;

  // Drag & Drop und Filter Funktionalität

  const availableMembers = document.getElementById('availableMembers');
  const teamDropZone = document.getElementById('teamDropZone');
  const selectedSchuelerIds = document.getElementById('selectedSchuelerIds');

  // Drag & Drop
  availableMembers.addEventListener('dragstart', e => {
    e.dataTransfer.setData('text/plain', e.target.dataset.id);
  });

  teamDropZone.addEventListener('dragover', e => e.preventDefault());
  
  teamDropZone.addEventListener('drop', e => {
    e.preventDefault();
    const memberId = e.dataTransfer.getData('text/plain');
    const member = availableMembers.querySelector(`[data-id="${memberId}"]`);
    member && addToTeam(member);
  });

  // Klick zum Hinzufügen
  availableMembers.addEventListener('click', e => {
    e.target.classList.contains('drag-item') && addToTeam(e.target);
  });

  function addToTeam(memberElement) {
    const memberId = memberElement.dataset.id;
    if (!teamDropZone.querySelector(`[data-id="${memberId}"]`)) {
      const teamMember = memberElement.cloneNode(true);
      teamMember.classList.replace('btn-outline-primary', 'bg-primary', 'text-white');
      
      const removeBtn = document.createElement('span');
      removeBtn.innerHTML = '×';
      removeBtn.onclick = () => removeFromTeam(memberId);
      teamMember.appendChild(removeBtn);
      
      teamDropZone.appendChild(teamMember);
      updateSelectedIds();
    }
  }

  function removeFromTeam(memberId) {
    teamDropZone.querySelector(`[data-id="${memberId}"]`)?.remove();
    updateSelectedIds();
  }

  function updateSelectedIds() {
    const selectedIds = [...teamDropZone.querySelectorAll('.drag-item')].map(item => item.dataset.id);
    selectedSchuelerIds.value = selectedIds.join(',');
  }

  function createTeamCard(teamId, databaseTeamId) {
  const teamCard = document.createElement('div');
  teamCard.className = 'team-card card mb-2';
  teamCard.dataset.teamId = teamId;
  
  teamCard.innerHTML = `
  <div class="card-body p-2">
    <h6 class="card-title">Team ${teamId}</h6>
    <div class="team-drop-zone border rounded p-2" 
         style="min-height: 60px; background-color: #f8f9fa; display: flex; flex-wrap: wrap; gap: 5px;">
      <p class="text-muted text-center mb-0 w-100 small">Teammitglieder hierher ziehen</p>
    </div>
    <input type="hidden" name="teams[]" value="${databaseTeamId}">
  </div>
`;

  const dropZone = teamCard.querySelector('.team-drop-zone');
  setupTeamDropZone(dropZone);

  return teamCard;
}

  addTeamBtn.addEventListener('click', function() {
  // ERSTMAL OHNE BACKEND TESTEN
  teamCounter++;
  const teamCard = createTeamCard(teamCounter, 'temp-' + teamCounter);
  teamsContainer.appendChild(teamCard);
  updateTeamInputs();
});

document.addEventListener('DOMContentLoaded', function() {


function setupTeamDropZone(dropZone) {
  dropZone.addEventListener('dragover', e => e.preventDefault());
  
  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    const memberId = e.dataTransfer.getData('text/plain');
    const member = availableMembers.querySelector(`[data-id="${memberId}"]`);
    if (member && !isMemberInAnyTeam(memberId)) {
      addMemberToTeam(member, dropZone);
      updateTeamInputs();
    }
  });
}

function addMemberToTeam(memberElement, dropZone) {
  const memberId = memberElement.dataset.id;
  
  const teamMember = document.createElement('span');
  teamMember.className = 'badge bg-primary team-member-tag';
  teamMember.dataset.id = memberId;
  teamMember.textContent = memberElement.textContent.replace(' ×', '');
  
  const removeBtn = document.createElement('span');
  removeBtn.innerHTML = ' ×';
  removeBtn.style.cursor = 'pointer';
  removeBtn.onclick = function() {
    teamMember.remove();
    updateTeamInputs();
  };
  
  teamMember.appendChild(removeBtn);
  
  const placeholder = dropZone.querySelector('p');
  if (placeholder) placeholder.remove();
  
  dropZone.appendChild(teamMember);
}

function isMemberInAnyTeam(memberId) {
  const allTeamMembers = document.querySelectorAll('.team-member-tag');
  return Array.from(allTeamMembers).some(member => member.dataset.id === memberId);
}

function updateTeamInputs() {
  const teamCards = document.querySelectorAll('.team-card');
  
  teamCards.forEach((card, index) => {
    const dropZone = card.querySelector('.team-drop-zone');
    const hiddenInput = card.querySelector('input[name="teams[]"]');
    
    const members = Array.from(dropZone.querySelectorAll('.team-member-tag'))
      .map(member => member.dataset.id);
    
    const teamData = {
      name: `Team ${index + 1}`,
      members: members
    };
    
    hiddenInput.value = JSON.stringify(teamData);
  });

}

  // Filter
  function filterMembers() {
    const nameValue = document.getElementById('nameFilter')?.value.toLowerCase() || '';
    const classValue = document.getElementById('classFilter')?.value || '';
    
    availableMembers.querySelectorAll('.drag-item').forEach(item => {
      const text = item.textContent.toLowerCase();
      const klasse = item.dataset.klasse?.toLowerCase() || '';
      const show = text.includes(nameValue) && (!classValue || klasse === classValue.toLowerCase());
      item.style.display = show ? 'block' : 'none';
    });
  }

  document.getElementById('nameFilter')?.addEventListener('input', filterMembers);
  document.getElementById('classFilter')?.addEventListener('change', filterMembers);

  // Initialisierung
  const initialIds = selectedSchuelerIds.value.split(',').filter(id => id);
  initialIds.forEach(id => {
    addToTeam(availableMembers.querySelector(`[data-id="${id}"]`));
  });

}); // <-- HIER schließt DOMContentLoaded

</script>