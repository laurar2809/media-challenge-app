<% pageTitle=title %>
<h1 class="h4 mb-3">
  <%= title %>
</h1>
<form action="<%= action %>" method="POST" id="challengeForm">
  
  <!-- Aufgabenpaket Auswahl -->
  <div class="mb-3">
    <label class="form-label">Aufgabenpaket *</label>
    <select name="aufgabenpaket_id" class="form-control" required>
      <option value="">Bitte wählen...</option>
      <% aufgabenpakete.forEach(paket => { %>
        <option value="<%= paket.id %>" 
          <%= (Number(item.aufgabenpaket_id) === Number(paket.id)) ? 'selected' : '' %>>
          <%= paket.title %> (<%= paket.kategorie %>)
        </option>
      <% }) %>
    </select>
  </div>

 <!-- TEAM MANAGEMENT SECTION -->
  <div class="mb-4 p-3 border rounded bg-light">
    <h5 class="mb-3">Team Management</h5>
    
    <!-- Filter für verfügbare Schüler -->
    <div class="row g-2 mb-3">
      <div class="col-md-6">
        <label class="form-label small">Nach Namen filtern</label>
        <input type="text" class="form-control form-control-sm" id="nameFilter" placeholder="Namen suchen...">
      </div>
      <div class="col-md-6">
        <label class="form-label small">Nach Klasse filtern</label>
        <select class="form-select form-select-sm" id="classFilter">
          <option value="">Alle Klassen</option>
          <% const klassen = [...new Set(schueler.map(s => s.klasse_name).filter(Boolean))]; %>
          <% klassen.forEach(klasse => { %>
            <option value="<%= klasse %>"><%= klasse %></option>
          <% }) %>
        </select>
      </div>
    </div>

    <!-- Verfügbare Schüler -->
    <div class="mb-3">
      <label class="form-label">Verfügbare Teammitglieder</label>
      <div class="d-flex flex-wrap gap-2" id="availableMembers">
        <% schueler.forEach(s => { %>
          <div class="btn btn-outline-primary btn-sm drag-item available-member" 
               data-id="<%= s.id %>" 
               data-klasse="<%= s.klasse_name %>" 
               draggable="true"
               data-vorname="<%= s.vorname %>"
               data-nachname="<%= s.nachname %>">
            <%= s.vorname %> <%= s.nachname %><% if (s.klasse_name) { %> - <%= s.klasse_name %><% } %>
          </div>
        <% }) %>
      </div>
    </div>

    <!-- Aktuelle Teams -->
    <div class="mb-3">
      <label class="form-label">Aktuelle Teams</label>
      <div id="teamsContainer">
        <!-- Teams werden hier dynamisch hinzugefügt -->
      </div>
    </div>

    <!-- Team Erstellen Bereich -->
    <div class="mb-3">
      <label class="form-label">Neues Team erstellen</label>
      <div class="card">
        <div class="card-body">
          <!-- Team Name -->
          <div class="mb-3">
            <label class="form-label small">Team Name *</label>
            <input type="text" class="form-control form-control-sm" id="newTeamName" placeholder="Team Name eingeben...">
          </div>
          
          <!-- Team Beschreibung -->
          <div class="mb-3">
            <label class="form-label small">Team Beschreibung</label>
            <textarea class="form-control form-control-sm" id="newTeamDescription" rows="2" placeholder="Optionale Beschreibung..."></textarea>
          </div>
          
          <!-- Drop Zone für Team Mitglieder -->
          <div class="mb-3">
            <label class="form-label small">Teammitglieder auswählen</label>
            <div class="drag-area border rounded p-3" id="teamDropZone" 
                 style="min-height: 100px; background-color: #f8f9fa; display: flex; flex-wrap: wrap; align-items: flex-start; gap: 5px;">
              <p class="text-muted text-center mb-0 w-100">Schüler hierher ziehen oder klicken</p>
            </div>
          </div>
          
          <!-- Team erstellen Button -->
          <button type="button" class="btn btn-success btn-sm" id="createTeamBtn">
            <i class="fas fa-plus"></i> Team erstellen
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Versteckte Inputs für Formular -->
  <input type="hidden" name="teams_data" id="teamsData" value="">

  <!-- Zusatzinfos -->
  <div class="mb-3">
    <label class="form-label">Challenge-Zusatzinformationen</label>
    <textarea name="zusatzinfos" class="form-control" rows="3" 
              placeholder="Spezielle Anweisungen oder Hinweise für diese Challenge"><%= item.zusatzinfos || '' %></textarea>
  </div>

  <!-- Abgabedatum -->
  <div class="mb-3">
    <label class="form-label">Abgabedatum</label>
    <input type="date" name="abgabedatum" class="form-control" value="<%= item.abgabedatum || '' %>">
  </div>

  <button type="submit" class="btn btn-custom-safe">Challenge erstellen</button>
  <a href="/challenges" class="btn btn-secondary">Abbrechen</a>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const availableMembers = document.getElementById('availableMembers');
  const teamDropZone = document.getElementById('teamDropZone');
  const teamsContainer = document.getElementById('teamsContainer');
  const createTeamBtn = document.getElementById('createTeamBtn');
  const teamsDataInput = document.getElementById('teamsData');
  const newTeamName = document.getElementById('newTeamName');
  const newTeamDescription = document.getElementById('newTeamDescription');
  const nameFilter = document.getElementById('nameFilter');
  const classFilter = document.getElementById('classFilter');
  
  let teams = [];
  let teamCounter = 1;

  // Drag & Drop Funktionen
  availableMembers.addEventListener('dragstart', e => {
    if (e.target.classList.contains('drag-item')) {
      e.dataTransfer.setData('text/plain', e.target.dataset.id);
    }
  });

  teamDropZone.addEventListener('dragover', e => e.preventDefault());
  
  teamDropZone.addEventListener('drop', e => {
    e.preventDefault();
    const memberId = e.dataTransfer.getData('text/plain');
    const member = availableMembers.querySelector(`[data-id="${memberId}"]`);
    if (member) {
      addMemberToDropZone(member);
    }
  });

  // Klick zum Hinzufügen in DropZone
  availableMembers.addEventListener('click', e => {
    if (e.target.classList.contains('drag-item')) {
      addMemberToDropZone(e.target);
    }
  });

  // Mitglied zur DropZone hinzufügen
  function addMemberToDropZone(memberElement) {
    const memberId = memberElement.dataset.id;
    
    // Prüfen ob Mitglied bereits in DropZone
    if (!teamDropZone.querySelector(`[data-id="${memberId}"]`)) {
      const teamMember = memberElement.cloneNode(true);
      teamMember.classList.remove('btn-outline-primary');
      teamMember.classList.add('bg-primary', 'text-white');
      
      const removeBtn = document.createElement('span');
      removeBtn.innerHTML = ' ×';
      removeBtn.style.cursor = 'pointer';
      removeBtn.style.marginLeft = '5px';
      removeBtn.onclick = function() {
        teamMember.remove();
        updatePlaceholder();
      };
      
      teamMember.appendChild(removeBtn);
      
      // Platzhalter entfernen
      const placeholder = teamDropZone.querySelector('p');
      if (placeholder) placeholder.remove();
      
      teamDropZone.appendChild(teamMember);
    }
  }

  // Platzhalter aktualisieren
  function updatePlaceholder() {
    if (teamDropZone.children.length === 0) {
      const placeholder = document.createElement('p');
      placeholder.className = 'text-muted text-center mb-0 w-100';
      placeholder.textContent = 'Schüler hierher ziehen oder klicken';
      teamDropZone.appendChild(placeholder);
    }
  }

  // Team erstellen
  createTeamBtn.addEventListener('click', function() {
    const teamName = newTeamName.value.trim();
    const teamDescription = newTeamDescription.value.trim();
    
    // Validierung
    if (!teamName) {
      alert('Bitte geben Sie einen Team Namen ein!');
      return;
    }
    
    const members = Array.from(teamDropZone.querySelectorAll('.drag-item'));
    if (members.length === 0) {
      alert('Bitte fügen Sie mindestens ein Teammitglied hinzu!');
      return;
    }
    
    // Team erstellen
    const team = {
      id: 'team-' + teamCounter++,
      name: teamName,
      beschreibung: teamDescription,
      mitglieder: members.map(member => ({
        id: parseInt(member.dataset.id),
        vorname: member.dataset.vorname,
        nachname: member.dataset.nachname,
        klasse: member.dataset.klasse
      }))
    };
    
    teams.push(team);
    renderTeams();
    clearTeamForm();
    updateTeamsData();
  });

  // Teams anzeigen
  function renderTeams() {
    teamsContainer.innerHTML = '';
    
    teams.forEach((team, index) => {
      const teamCard = document.createElement('div');
      teamCard.className = 'card mb-2';
      teamCard.innerHTML = `
        <div class="card-body p-2">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="card-title mb-0">${team.name}</h6>
            <button type="button" class="btn btn-outline-danger btn-sm remove-team" data-index="${index}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          ${team.beschreibung ? `<p class="small text-muted mb-1">${team.beschreibung}</p>` : ''}
          <div class="mt-1">
            ${team.mitglieder.map(m => 
              `<span class="badge bg-secondary me-1">${m.vorname} ${m.nachname}</span>`
            ).join('')}
          </div>
        </div>
      `;
      teamsContainer.appendChild(teamCard);
    });

    // Event Listener für Remove Buttons
    teamsContainer.querySelectorAll('.remove-team').forEach(btn => {
      btn.addEventListener('click', function() {
        const index = parseInt(this.dataset.index);
        teams.splice(index, 1);
        renderTeams();
        updateTeamsData();
      });
    });
  }

  // Team Formular zurücksetzen
  function clearTeamForm() {
    newTeamName.value = '';
    newTeamDescription.value = '';
    teamDropZone.innerHTML = '<p class="text-muted text-center mb-0 w-100">Schüler hierher ziehen oder klicken</p>';
  }

  // Teams Daten für Formular aktualisieren
  function updateTeamsData() {
    teamsDataInput.value = JSON.stringify(teams);
  }

  // Filter Funktionen
  function filterMembers() {
    const nameValue = nameFilter.value.toLowerCase();
    const classValue = classFilter.value.toLowerCase();
    
    availableMembers.querySelectorAll('.available-member').forEach(item => {
      const text = item.textContent.toLowerCase();
      const klasse = item.dataset.klasse?.toLowerCase() || '';
      const show = text.includes(nameValue) && 
                  (!classValue || klasse.includes(classValue));
      item.style.display = show ? 'inline-block' : 'none';
    });
  }

  // Event Listener für Filter
  if (nameFilter) {
    nameFilter.addEventListener('input', filterMembers);
  }
  
  if (classFilter) {
    classFilter.addEventListener('change', filterMembers);
  }

  // Formular Submit validieren
  document.getElementById('challengeForm').addEventListener('submit', function(e) {
    if (teams.length === 0) {
      e.preventDefault();
      alert('Bitte erstellen Sie mindestens ein Team für diese Challenge!');
      return;
    }
  });

  // Initialisierung
  updatePlaceholder();
});
</script>